<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Domain Monitoring | Dashboard</title>

    <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    
    <style>
        .brand-link {
            background: #343a40 !important;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .filter-btn {
            margin: 0 5px;
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }
        .badge-is-for-sale {
            background-color: #28a745 !important;
            color: white;
        }
        .badge-failed {
            background-color: #dc3545 !important;
            color: white;
        }
        .badge-other {
            background-color: #fd7e14 !important;
            color: white;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .bulk-actions {
            display: none;
            margin-bottom: 15px;
        }
        .bulk-actions.show {
            display: block;
        }
        .domain-checkbox {
            cursor: pointer;
        }
        .user-panel .image {
            padding-left: 10px;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="index.html" class="nav-link">Dashboard</a>
            </li>
        </ul>

        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell"></i>
                    <span class="badge badge-warning navbar-badge" id="alertCount">0</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">Notifications</span>
                    <div class="dropdown-divider"></div>
                    <div id="alertsList"></div>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-user"></i>
                    <span class="d-none d-md-inline ml-1" id="usernameDisplay"></span>
                </a>
                <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">
                    <a href="#" class="dropdown-item" id="userEmail">
                        <i class="fas fa-envelope mr-2"></i> <span id="emailDisplay"></span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </a>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="index.html" class="brand-link">
            <i class="fas fa-globe brand-image ml-3"></i>
            <span class="brand-text font-weight-light">Domain Monitor</span>
        </a>

        <div class="sidebar">
            <!-- User Panel -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
                    <i class="fas fa-user-circle fa-2x text-white"></i>
                </div>
                <div class="info">
                    <a href="#" class="d-block" id="sidebarUsername">User</a>
                </div>
            </div>

            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link active">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showAddDomainModal()">
                            <i class="nav-icon fas fa-plus-circle"></i>
                            <p>Add Domain</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showBulkAddModal()">
                            <i class="nav-icon fas fa-list"></i>
                            <p>Bulk Add Domains</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="triggerScan()">
                            <i class="nav-icon fas fa-sync"></i>
                            <p>Trigger Scan</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="exportCSV()">
                            <i class="nav-icon fas fa-download"></i>
                            <p>Export CSV</p>
                        </a>
                    </li>
                    <li class="nav-divider"></li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="logout()">
                            <i class="nav-icon fas fa-sign-out-alt"></i>
                            <p>Logout</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Dashboard</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active">Dashboard</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                
                <!-- Stats Row -->
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info stats-card">
                            <div class="inner">
                                <h3 id="totalDomains">0</h3>
                                <p>Total Domains</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <a href="#" class="small-box-footer" onclick="filterDomains('all')">View all <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success stats-card">
                            <div class="inner">
                                <h3 id="isForSaleCount">0</h3>
                                <p>Is For Sale</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <a href="#" class="small-box-footer" onclick="filterDomains('is_for_sale')">View details <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger stats-card">
                            <div class="inner">
                                <h3 id="failedCount">0</h3>
                                <p>Failed</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <a href="#" class="small-box-footer" onclick="filterDomains('failed')">View details <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning stats-card">
                            <div class="inner">
                                <h3 id="otherCount">0</h3>
                                <p>Other</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <a href="#" class="small-box-footer" onclick="filterDomains('other')">View details <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                </div>

                <!-- Status Distribution Chart -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-pie mr-1"></i>
                                    Status Distribution
                                </h3>
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    System Information
                                </h3>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-6">Average Response Time:</dt>
                                    <dd class="col-sm-6"><span id="avgResponseTime">0</span> ms</dd>
                                    
                                    <dt class="col-sm-6">Last Scan:</dt>
                                    <dd class="col-sm-6" id="lastScanTime">Never</dd>
                                    
                                    <dt class="col-sm-6">Unread Alerts:</dt>
                                    <dd class="col-sm-6"><span class="badge badge-warning" id="unreadAlerts">0</span></dd>
                                    
                                    <dt class="col-sm-6">Active Filters:</dt>
                                    <dd class="col-sm-6"><span class="badge badge-info" id="activeFilter">All</span></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Domain List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list mr-1"></i>
                            Domain List
                        </h3>
                        <div class="card-tools">
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <input type="text" id="searchInput" class="form-control float-right" placeholder="Search domain...">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-default" onclick="searchDomains()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Filter Buttons -->
                        <div class="p-3 border-bottom">
                            <button class="btn btn-sm btn-outline-primary filter-btn active" onclick="filterDomains('all')" data-filter="all">
                                <i class="fas fa-list"></i> All
                            </button>
                            <button class="btn btn-sm btn-outline-success filter-btn" onclick="filterDomains('is_for_sale')" data-filter="is_for_sale">
                                <i class="fas fa-tag"></i> Is For Sale
                            </button>
                            <button class="btn btn-sm btn-outline-danger filter-btn" onclick="filterDomains('failed')" data-filter="failed">
                                <i class="fas fa-times-circle"></i> Failed
                            </button>
                            <button class="btn btn-sm btn-outline-warning filter-btn" onclick="filterDomains('other')" data-filter="other">
                                <i class="fas fa-question-circle"></i> Other
                            </button>
                        </div>

                        <!-- Bulk Actions -->
                        <div id="bulkActions" class="bulk-actions p-3 bg-light border-bottom">
                            <strong><span id="selectedCount">0</span> domains selected</strong>
                            <button class="btn btn-sm btn-danger ml-3" onclick="bulkDeleteSelected()">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-sm btn-secondary ml-2" onclick="clearSelection()">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                                        </th>
                                        <th>Domain</th>
                                        <th>Status</th>
                                        <th>HTTP Code</th>
                                        <th>Response Time</th>
                                        <th>Last Scan</th>
                                        <th style="width: 150px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="domainTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <strong>Copyright &copy; 2024 Domain Monitor.</strong>
        All rights reserved.
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 2.0.0
        </div>
    </footer>
</div>

<!-- Modals -->
<!-- Add Domain Modal -->
<div class="modal fade" id="addDomainModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Domain</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addDomainForm">
                    <div class="form-group">
                        <label>Domain *</label>
                        <input type="text" class="form-control" id="newDomain" placeholder="example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control" id="domainNotes" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Custom Keywords (one per line)</label>
                        <textarea class="form-control" id="customKeywords" rows="3" placeholder="is for sale&#10;domain for sale"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addDomain()">Add Domain</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add Domains</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bulkAddForm">
                    <div class="form-group">
                        <label>Domains (one per line) *</label>
                        <textarea class="form-control" id="bulkDomains" rows="10" placeholder="example.com&#10;test-domain.net&#10;sample.org" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Custom Keywords (one per line, applies to all)</label>
                        <textarea class="form-control" id="bulkKeywords" rows="3" placeholder="is for sale&#10;domain for sale"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="bulkAddDomains()">Add All Domains</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 4 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Configuration
const API_BASE_URL = // Using IP address 74.48.129.112 with port 8080
const API_BASE_URL = 'http://74.48.129.112:8080/api';
    ? 'http://localhost:8000/api'
    : '/api';

let currentFilter = 'all';
let selectedDomains = new Set();
let statusChart = null;

// Check authentication on page load
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('auth_token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // Load user info
    loadUserInfo();
    
    // Load dashboard data
    loadDashboard();
    loadDomains();
    loadAlerts();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadDashboard();
        loadDomains();
    }, 30000);
});

// Get auth headers
function getAuthHeaders() {
    const token = localStorage.getItem('auth_token');
    return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
}

// Handle unauthorized responses
async function handleResponse(response) {
    if (response.status === 401) {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_info');
        window.location.href = 'login.html';
        throw new Error('Unauthorized');
    }
    return response;
}

// Load user info
async function loadUserInfo() {
    try {
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        $('#usernameDisplay').text(userInfo.username || 'User');
        $('#sidebarUsername').text(userInfo.username || 'User');
        $('#emailDisplay').text(userInfo.email || 'No email');
        
        // Verify token with backend
        const response = await fetch(`${API_BASE_URL}/auth/me`, {
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        
        if (response.ok) {
            const data = await response.json();
            localStorage.setItem('user_info', JSON.stringify(data));
            $('#usernameDisplay').text(data.username);
            $('#sidebarUsername').text(data.username);
            $('#emailDisplay').text(data.email || 'No email');
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

// Logout
async function logout() {
    try {
        await fetch(`${API_BASE_URL}/auth/logout`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
    } catch (error) {
        console.error('Logout error:', error);
    } finally {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_info');
        window.location.href = 'login.html';
    }
}

// Load dashboard summary
async function loadDashboard() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/summary`, {
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        const data = await response.json();
        
        $('#totalDomains').text(data.total_domains);
        $('#isForSaleCount').text(data.is_for_sale_count);
        $('#failedCount').text(data.failed_count);
        $('#otherCount').text(data.other_count);
        $('#avgResponseTime').text(Math.round(data.avg_response_time));
        $('#unreadAlerts').text(data.unread_alerts);
        $('#alertCount').text(data.unread_alerts);
        
        if (data.last_scan_time) {
            $('#lastScanTime').text(new Date(data.last_scan_time).toLocaleString());
        }
        
        // Update status distribution chart
        loadStatusChart();
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

// Load status distribution chart
async function loadStatusChart() {
    try {
        const response = await fetch(`${API_BASE_URL}/stats/distribution`, {
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        const data = await response.json();
        
        const ctx = document.getElementById('statusChart');
        
        if (statusChart) {
            statusChart.destroy();
        }
        
        const colors = data.labels.map(label => {
            if (label === 'is_for_sale') return '#28a745';
            if (label === 'failed') return '#dc3545';
            if (label === 'other') return '#fd7e14';
            return '#6c757d';
        });
        
        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels.map(label => {
                    if (label === 'is_for_sale') return 'Is For Sale';
                    if (label === 'failed') return 'Failed';
                    if (label === 'other') return 'Other';
                    return label;
                }),
                datasets: [{
                    data: data.values,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading chart:', error);
    }
}

// Load domains
async function loadDomains() {
    try {
        let url = `${API_BASE_URL}/domains?limit=100`;
        if (currentFilter !== 'all') {
            url += `&status=${currentFilter}`;
        }
        
        const searchTerm = $('#searchInput').val().trim();
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        const response = await fetch(url, {
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        const domains = await response.json();
        
        displayDomains(domains);
    } catch (error) {
        console.error('Error loading domains:', error);
    }
}

// Display domains in table
function displayDomains(domains) {
    const tbody = $('#domainTableBody');
    tbody.empty();
    
    if (domains.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="7" class="text-center text-muted">No domains found</td>
            </tr>
        `);
        return;
    }
    
    domains.forEach(domain => {
        const statusBadge = getStatusBadge(domain.status);
        const scanTime = domain.scan_time ? new Date(domain.scan_time).toLocaleString() : 'Never';
        
        const row = $(`
            <tr>
                <td>
                    <input type="checkbox" class="domain-checkbox" value="${domain.id}" 
                           onchange="toggleDomainSelection(${domain.id})"
                           ${selectedDomains.has(domain.id) ? 'checked' : ''}>
                </td>
                <td>
                    <strong>${domain.domain}</strong>
                    ${domain.keyword_found ? `<br><small class="text-muted">Keyword: ${domain.keyword_found}</small>` : ''}
                </td>
                <td>${statusBadge}</td>
                <td>${domain.http_status_code || '-'}</td>
                <td>${domain.response_time_ms ? domain.response_time_ms + ' ms' : '-'}</td>
                <td>${scanTime}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteSingleDomain(${domain.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
        
        tbody.append(row);
    });
}

// Get status badge HTML
function getStatusBadge(status) {
    if (status === 'is_for_sale') {
        return '<span class="badge badge-is-for-sale">Is For Sale</span>';
    } else if (status === 'failed') {
        return '<span class="badge badge-failed">Failed</span>';
    } else if (status === 'other') {
        return '<span class="badge badge-other">Other</span>';
    }
    return '<span class="badge badge-secondary">' + status + '</span>';
}

// Filter domains
function filterDomains(filter) {
    currentFilter = filter;
    $('#activeFilter').text(filter === 'all' ? 'All' : filter.replace('_', ' ').toUpperCase());
    
    // Update button states
    $('.filter-btn').removeClass('active');
    $(`.filter-btn[data-filter="${filter}"]`).addClass('active');
    
    loadDomains();
}

// Search domains
function searchDomains() {
    loadDomains();
}

// Enter key search
$('#searchInput').on('keypress', function(e) {
    if (e.which === 13) {
        searchDomains();
    }
});

// Load alerts
async function loadAlerts() {
    try {
        const response = await fetch(`${API_BASE_URL}/alerts?unread_only=true&limit=5`, {
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        const alerts = await response.json();
        
        const alertsList = $('#alertsList');
        alertsList.empty();
        
        if (alerts.length === 0) {
            alertsList.append('<span class="dropdown-item text-muted">No new alerts</span>');
        } else {
            alerts.forEach(alert => {
                alertsList.append(`
                    <a href="#" class="dropdown-item" onclick="markAlertRead(${alert.id})">
                        <i class="fas fa-exclamation-triangle text-${alert.severity === 'error' ? 'danger' : 'warning'} mr-2"></i>
                        ${alert.message}
                        <br><small class="text-muted">${new Date(alert.created_at).toLocaleString()}</small>
                    </a>
                    <div class="dropdown-divider"></div>
                `);
            });
        }
    } catch (error) {
        console.error('Error loading alerts:', error);
    }
}

// Mark alert as read
async function markAlertRead(alertId) {
    try {
        await fetch(`${API_BASE_URL}/alerts/${alertId}/read`, {
            method: 'PATCH',
            headers: getAuthHeaders()
        });
        loadAlerts();
        loadDashboard();
    } catch (error) {
        console.error('Error marking alert as read:', error);
    }
}

// Show modals
function showAddDomainModal() {
    $('#addDomainModal').modal('show');
    $('#newDomain').val('');
    $('#domainNotes').val('');
    $('#customKeywords').val('');
}

function showBulkAddModal() {
    $('#bulkAddModal').modal('show');
    $('#bulkDomains').val('');
    $('#bulkKeywords').val('');
}

// Add single domain
async function addDomain() {
    const domain = $('#newDomain').val().trim();
    const notes = $('#domainNotes').val().trim();
    const keywordsText = $('#customKeywords').val().trim();
    
    if (!domain) {
        alert('Please enter a domain');
        return;
    }
    
    const keywords = keywordsText ? keywordsText.split('\n').filter(k => k.trim()) : null;
    
    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/domains`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
                domain: domain,
                notes: notes || null,
                custom_keywords: keywords,
                check_keywords: true
            })
        });
        
        await handleResponse(response);
        hideLoading();
        
        if (response.ok) {
            $('#addDomainModal').modal('hide');
            showToast('Domain added successfully', 'success');
            loadDomains();
            loadDashboard();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Error adding domain', 'error');
        }
    } catch (error) {
        hideLoading();
        showToast('Error adding domain', 'error');
    }
}

// Bulk add domains
async function bulkAddDomains() {
    const domainsText = $('#bulkDomains').val().trim();
    const keywordsText = $('#bulkKeywords').val().trim();
    
    if (!domainsText) {
        alert('Please enter at least one domain');
        return;
    }
    
    const domains = domainsText.split('\n').filter(d => d.trim());
    const keywords = keywordsText ? keywordsText.split('\n').filter(k => k.trim()) : null;
    
    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/domains/bulk`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
                domains: domains,
                custom_keywords: keywords,
                check_keywords: true
            })
        });
        
        await handleResponse(response);
        const result = await response.json();
        hideLoading();
        
        $('#bulkAddModal').modal('hide');
        
        showToast(
            `Added ${result.total_added} domains. Failed: ${result.total_failed}`,
            result.total_failed > 0 ? 'warning' : 'success'
        );
        
        loadDomains();
        loadDashboard();
    } catch (error) {
        hideLoading();
        showToast('Error adding domains', 'error');
    }
}

// Selection management
function toggleDomainSelection(domainId) {
    if (selectedDomains.has(domainId)) {
        selectedDomains.delete(domainId);
    } else {
        selectedDomains.add(domainId);
    }
    updateSelectionUI();
}

function toggleSelectAll() {
    const isChecked = $('#selectAll').prop('checked');
    $('.domain-checkbox').prop('checked', isChecked);
    
    if (isChecked) {
        $('.domain-checkbox').each(function() {
            selectedDomains.add(parseInt($(this).val()));
        });
    } else {
        selectedDomains.clear();
    }
    
    updateSelectionUI();
}

function clearSelection() {
    selectedDomains.clear();
    $('.domain-checkbox').prop('checked', false);
    $('#selectAll').prop('checked', false);
    updateSelectionUI();
}

function updateSelectionUI() {
    const count = selectedDomains.size;
    $('#selectedCount').text(count);
    
    if (count > 0) {
        $('#bulkActions').addClass('show');
    } else {
        $('#bulkActions').removeClass('show');
    }
}

// Delete single domain
async function deleteSingleDomain(domainId) {
    if (!confirm('Are you sure you want to delete this domain?')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/domains/${domainId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        hideLoading();
        showToast('Domain deleted successfully', 'success');
        selectedDomains.delete(domainId);
        loadDomains();
        loadDashboard();
    } catch (error) {
        hideLoading();
        showToast('Error deleting domain', 'error');
    }
}

// Bulk delete selected
async function bulkDeleteSelected() {
    if (selectedDomains.size === 0) {
        alert('Please select domains to delete');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedDomains.size} domains?`)) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/domains/bulk-delete`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
                domain_ids: Array.from(selectedDomains)
            })
        });
        
        await handleResponse(response);
        const result = await response.json();
        hideLoading();
        
        showToast(result.message, 'success');
        selectedDomains.clear();
        loadDomains();
        loadDashboard();
    } catch (error) {
        hideLoading();
        showToast('Error deleting domains', 'error');
    }
}

// Trigger manual scan
async function triggerScan() {
    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/scan/trigger`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        await handleResponse(response);
        hideLoading();
        showToast('Scan triggered successfully', 'success');
    } catch (error) {
        hideLoading();
        showToast('Error triggering scan', 'error');
    }
}

// Export CSV
async function exportCSV() {
    try {
        showLoading();
        let url = `${API_BASE_URL}/export/csv`;
        if (currentFilter !== 'all') {
            url += `?status=${currentFilter}`;
        }
        
        const token = localStorage.getItem('auth_token');
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', '');
        
        // Create a temporary form to send auth header
        fetch(url, {
            headers: getAuthHeaders()
        }).then(response => response.blob())
          .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `domains_${new Date().getTime()}.csv`;
              document.body.appendChild(a);
              a.click();
              a.remove();
          });
        
        hideLoading();
    } catch (error) {
        hideLoading();
        showToast('Error exporting CSV', 'error');
    }
}

// Loading overlay
function showLoading() {
    $('#loadingOverlay').css('display', 'flex');
}

function hideLoading() {
    $('#loadingOverlay').hide();
}

// Toast notification
function showToast(message, type) {
    const toast = $(`
        <div class="alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} alert-dismissible" style="position: fixed; top: 70px; right: 20px; z-index: 9999; min-width: 300px;">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            ${message}
        </div>
    `);
    
    $('body').append(toast);
    
    setTimeout(() => {
        toast.fadeOut(() => toast.remove());
    }, 3000);
}
</script>

</body>
</html>
